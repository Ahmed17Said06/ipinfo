<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit IPs</title>
</head>
<body>
    <h1>Submit IPs</h1>
    <form id="ipForm">
        <textarea id="ips" rows="10" cols="50" placeholder="Enter IPs separated by commas"></textarea><br>
        <button type="submit">Submit</button>
    </form>
    <div id="results"></div>

    <script>
        document.getElementById('ipForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const ips = document.getElementById('ips').value.split(',').map(ip => ip.trim());
            fetch('/ipinfo/submit-ips/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ips: ips }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const taskIds = data.task_ids;
                    const eventSource = new EventSource(`/ipinfo/stream/?task_ids=${taskIds.join(',')}`);
                    eventSource.onmessage = function(event) {
                        const result = JSON.parse(event.data);
                        document.getElementById('results').innerHTML += formatResult(result);
                    };
                } else {
                    document.getElementById('results').innerHTML = `<div style="color: red;"><strong>Error:</strong> ${data.message}</div>`;
                }
            })
            .catch(error => {
                document.getElementById('results').innerHTML = `<div style="color: red;"><strong>Error:</strong> ${error.message}</div>`;
            });
        });

        function formatResult(data) {
            if (data.info) {
                return `
                    <div>
                        <strong>IP:</strong> ${data.ip}<br>
                        <strong>Info:</strong> ${JSON.stringify(data.info, null, 2)}
                    </div>
                `;
            }

            if (data.error) {
                return `
                    <div style="color: red;">
                        <strong>Error:</strong> ${data.error}
                    </div>
                `;
            }

            return `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
    </script>
</body>
</html>
